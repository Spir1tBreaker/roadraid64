<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Raidroad64 ‚Äî –∫–∞—Ä—Ç–∞ –î–ü–° –°–∞—Ä–∞—Ç–æ–≤–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ URL -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=be618309-d3fc-4f6c-ab23-f2579450d397&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div class="menu-toggle-wrapper" id="menuToggle">
    <div class="menu-toggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="user-profile">
      <h3 id="menu-username">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
      <p id="menu-level">Lv.1</p>
    </div>
    <button class="menu-btn sos" id="sosBtn">üö® SOS</button>
    <button class="menu-btn" id="leaderboardBtn">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
    <button class="menu-btn" id="newsBtn">üì∞ –ù–æ–≤–æ—Å—Ç–∏</button>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="header">
    <h1>Raidroad64</h1>
    <div style="display:flex; align-items:center; gap:12px;">
      <div style="position:relative;">
        <input
          type="text"
          id="search-input"
          placeholder="–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã..."
          style="
            background: rgba(26,26,26,0.8);
            border: 1px solid #ff3b30;
            color: white;
            padding: 6px 28px 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            width: 180px;
            outline: none;
          "
        >
        <span style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          color: #ff3b30;
          font-size: 16px;
        ">üîç</span>
      </div>
      <p style="margin:0; color:#aaa;">–ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span>!</p>
    </div>
  </div>
  <div id="map"></div>

  <div id="report-form" style="display:none;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É</h3>
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –∑–¥–µ—Å—å –î–ü–°?</p>
    <button id="confirm-btn">‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å</button>
    <button id="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
  </div>

  <div id="geolocate-btn" style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: #1a1a1a;
    color: white;
    border: 2px solid #ff3b30;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-size: 20px;
  ">
    üìç
  </div>

  <script>
    let map, selectedCoord = null;
    let placemarks = {};
    let currentUsername = '';
    let activePopup = null;

    fetch('/api/me')
      .then(res => res.ok ? res.json() : Promise.reject())
      .then(data => {
        currentUsername = data.username || '–ê–Ω–æ–Ω–∏–º';
        document.getElementById('user-name').textContent = currentUsername;
        document.getElementById('menu-username').textContent = currentUsername;
        ymaps.ready(initMap);
      })
      .catch(() => window.location.href = '/login');

    function initMap() {
      map = new ymaps.Map("map", {
        center: [51.540497, 46.008789],
        zoom: 11,
        controls: ['zoomControl']
      });

      loadReports();
      setInterval(loadReports, 30000);

      map.events.add('click', e => {
        selectedCoord = e.get('coords');
        document.getElementById('report-form').style.display = 'block';
      });

      document.getElementById('confirm-btn').onclick = () => {
        if (!selectedCoord) return;
        fetch('/api/report', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ lat: selectedCoord[0], lon: selectedCoord[1] })
        }).then(() => {
          document.getElementById('report-form').style.display = 'none';
          loadReports();
        });
      };

      document.getElementById('cancel-btn').onclick = () => {
        document.getElementById('report-form').style.display = 'none';
      };
    }

    function loadReports() {
      for (let id in placemarks) map.geoObjects.remove(placemarks[id]);
      placemarks = {};

      fetch('/api/reports')
        .then(res => res.json())
        .then(reports => {
          reports.forEach(r => {
            const reportTime = new Date(r.timestamp + 'Z');
            const now = new Date();
            const hoursAgo = (now - reportTime) / (1000 * 60 * 60);

            let color = null;
            if (hoursAgo <= 1) color = '#ff0000';
            else if (hoursAgo <= 2) color = '#ffcc00';
            else if (hoursAgo <= 2.5) color = '#00aa00';
            if (!color) return;

            const placemark = new ymaps.Placemark([r.lat, r.lon], {}, {
              preset: 'islands#circleIcon',
              iconColor: color
            });

            placemark.events.add('click', () => {
              showStylishPopup(r, currentUsername === r.username);
            });

            placemarks[r.id] = placemark;
            map.geoObjects.add(placemark);
          });
        });
    }

    function showStylishPopup(report, isOwn) {
      if (activePopup) {
        activePopup.remove();
        activePopup = null;
      }

      const popupContent = `
        <div style="
          background: #1a1a1a;
          color: white;
          border: 2px solid #ff3b30;
          border-radius: 12px;
          padding: 14px;
          box-shadow: 0 6px 20px rgba(255, 59, 48, 0.4);
          font-size: 14px;
          max-width: 200px;
          animation: popupFadeIn 0.2s ease;
        ">
          <div style="margin-bottom: 10px;">
            <b>${report.username}</b><br>
            <small style="color: #aaa;">${report.time_str}</small>
          </div>
          <button id="popup-gone" style="
            width: 100%;
            padding: 8px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
          ">üöó –£–µ—Ö–∞–ª–∏</button>
          ${isOwn ? `
            <button id="popup-delete" style="
              width: 100%;
              margin-top: 8px;
              padding: 8px;
              background: #f44336;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              transition: transform 0.1s, background 0.2s;
            ">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          ` : ''}
        </div>
      `;

      const hint = new ymaps.HtmlHint(popupContent);
      map.hint.open([report.lat, report.lon], hint);
      activePopup = hint;

      // –ê–Ω–∏–º–∞—Ü–∏—è
      if (!document.getElementById('popup-styles')) {
        const style = document.createElement('style');
        style.id = 'popup-styles';
        style.innerHTML = `
          @keyframes popupFadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
          }
        `;
        document.head.appendChild(style);
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      setTimeout(() => {
        const goneBtn = document.getElementById('popup-gone');
        if (goneBtn) {
          goneBtn.onclick = () => {
            fetch('/api/vote', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ report_id: report.id, type: 'gone' })
            }).then(() => {
              map.hint.close();
              loadReports();
            });
          };
        }

        const deleteBtn = document.getElementById('popup-delete');
        if (deleteBtn) {
          deleteBtn.onclick = () => {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É?')) {
              fetch(`/api/report/${report.id}`, { method: 'DELETE' })
                .then(() => {
                  map.hint.close();
                  loadReports();
                });
            }
          };
        }
      }, 100);
    }

    // === –ú–µ–Ω—é ===
    document.getElementById('menuToggle').onclick = () => {
      document.getElementById('sidebar').classList.add('active');
      document.getElementById('overlay').classList.add('active');
    };
    document.getElementById('overlay').onclick = () => {
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    };

    // === Telegram-–∫–∞–Ω–∞–ª—ã (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤!) ===
    document.getElementById('sosBtn').onclick = () => window.open('https://t.me/+WFDKSUr0XSgyMGI6', '_blank');
    document.getElementById('leaderboardBtn').onclick = () => window.open('https://t.me/+EAd7iBOKoBlkMGFi', '_blank');
    document.getElementById('newsBtn').onclick = () => window.open('https://t.me/raidroad64_news', '_blank');

    // === –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è ===
    document.getElementById('geolocate-btn').onclick = function() {
      if (!navigator.geolocation) return alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
      const btn = this;
      btn.innerHTML = '‚è≥'; btn.style.borderColor = '#ff9999';
      navigator.geolocation.getCurrentPosition(
        pos => {
          map.setCenter([pos.coords.latitude, pos.coords.longitude], 14);
          btn.innerHTML = 'üìç'; btn.style.borderColor = '#ff3b30';
        },
        err => {
          alert(err.code === 1 ? '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          btn.innerHTML = 'üìç'; btn.style.borderColor = '#ff3b30';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    };

    // === –ü–æ–∏—Å–∫ –ø–æ —É–ª–∏—Ü–∞–º ===
    document.getElementById('search-input').onkeypress = e => {
      if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (q) {
          ymaps.geocode(q + ', –°–∞—Ä–∞—Ç–æ–≤', { results: 1 }).then(res => {
            if (res.geoObjects.getLength()) {
              const c = res.geoObjects.get(0).geometry.getCoordinates();
              map.setCenter(c, 15, { duration: 500 });
              e.target.value = '';
            } else alert('–£–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          });
        }
      }
    };
  </script>
</body>
</html>