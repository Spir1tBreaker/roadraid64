<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Raidroad64 ‚Äî –∫–∞—Ä—Ç–∞ –î–ü–° –°–∞—Ä–∞—Ç–æ–≤–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <!-- –£–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ URL -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=be618309-d3fc-4f6c-ab23-f2579450d397&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é -->
  <div class="menu-toggle-wrapper" id="menuToggle">
    <div class="menu-toggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div class="sidebar" id="sidebar">
    <div class="user-profile">
      <h3 id="menu-username">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
      <p id="menu-level">Lv.1</p>
    </div>
    <button class="menu-btn sos" id="sosBtn">üö® SOS</button>
    <button class="menu-btn" id="leaderboardBtn">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
    <button class="menu-btn" id="newsBtn">üì∞ –ù–æ–≤–æ—Å—Ç–∏</button>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="header">
    <h1>Raidroad64</h1>
    <p>–ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span>!</p>
  </div>
  <div id="map"></div>

  <div id="report-form" style="display:none;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É</h3>
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –∑–¥–µ—Å—å –î–ü–°?</p>
    <button id="confirm-btn">‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å</button>
    <button id="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
  </div>

  <!-- üî¥ –ö–Ω–æ–ø–∫–∞ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" -->
  <div id="geolocate-btn" style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: #1a1a1a;
    color: white;
    border: 2px solid #ff3b30;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-size: 20px;
  ">
    üìç
  </div>

  <script>
    let map, selectedCoord = null;
    let placemarks = {};
    let currentUsername = '';

    fetch('/api/me')
      .then(res => {
        if (!res.ok) throw new Error('Not authorized');
        return res.json();
      })
      .then(data => {
        currentUsername = data.username || '–ê–Ω–æ–Ω–∏–º';
        document.getElementById('user-name').textContent = currentUsername;
        document.getElementById('menu-username').textContent = currentUsername;
        ymaps.ready(initMap);
      })
      .catch(() => {
        window.location.href = '/login';
      });

    function initMap() {
      map = new ymaps.Map("map", {
        center: [51.540497, 46.008789],
        zoom: 11,
        controls: ['zoomControl']
      });

      loadReports();
      setInterval(loadReports, 30000);

      map.events.add('click', function (e) {
        selectedCoord = e.get('coords');
        document.getElementById('report-form').style.display = 'block';
      });

      document.getElementById('confirm-btn').onclick = function() {
        if (!selectedCoord) return;
        fetch('/api/report', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ lat: selectedCoord[0], lon: selectedCoord[1] })
        }).then(() => {
          document.getElementById('report-form').style.display = 'none';
          loadReports();
        });
      };

      document.getElementById('cancel-btn').onclick = function() {
        document.getElementById('report-form').style.display = 'none';
      };
    }

    function loadReports() {
      for (let id in placemarks) map.geoObjects.remove(placemarks[id]);
      placemarks = {};

      fetch('/api/reports')
        .then(res => res.json())
        .then(reports => {
          reports.forEach(r => {
            const timeDiff = new Date() - new Date(r.timestamp || '2025-01-01');
            const hoursAgo = timeDiff / (1000 * 60 * 60);
            let color = '#888';
            if (hoursAgo <= 0.5) color = '#ff0000';
            else if (hoursAgo <= 1.5) color = '#ffcc00';
            else if (hoursAgo <= 2) color = '#00aa00';

            // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Äî –±–µ–∑ onclick
            const content = `
              <div style="background:white; padding:6px; border-radius:6px; font-size:12px; min-width:120px;">
                <b>${r.username}</b><br>
                <small>${r.time_str}</small><br>
                <div style="margin-top:6px; display:flex; gap:4px;">
                  <button class="vote-btn" data-report-id="${r.id}" data-type="like"
                          style="flex:1; background:#4CAF50; color:white; border:0; padding:2px; border-radius:3px; font-size:10px;">
                    üëç ${r.likes}
                  </button>
                  <button class="vote-btn" data-report-id="${r.id}" data-type="gone"
                          style="flex:1; background:#ff9800; color:white; border:0; padding:2px; border-radius:3px; font-size:10px;">
                    üöó ${r.gone_count}
                  </button>
                </div>
              </div>
            `;

            const placemark = new ymaps.Placemark([r.lat, r.lon], { balloonContent: content }, {
              preset: 'islands#circleIcon',
              iconColor: color
            });

            if (currentUsername === r.username) {
              const deleteBtn = `<br><button onclick="deleteReport(${r.id})" style="margin-top:6px; background:#f44336; color:white; border:0; padding:2px 6px; border-radius:3px; font-size:10px; width:100%;">–£–¥–∞–ª–∏—Ç—å</button>`;
              placemark.properties.set('balloonContent', content + deleteBtn);
            }

            placemarks[r.id] = placemark;
            map.geoObjects.add(placemark);
          });
        });
    }

    // ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–±–µ–∑ –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞)
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('vote-btn')) {
        const reportId = e.target.getAttribute('data-report-id');
        const type = e.target.getAttribute('data-type');
        fetch('/api/vote', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ report_id: reportId, type: type })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'voted') {
            loadReports();
          } else {
            alert('–£–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏');
          }
        });
      }
    });

    function deleteReport(reportId) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        fetch(`/api/report/${reportId}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'deleted') loadReports();
            else alert('–û—à–∏–±–∫–∞');
          });
      }
    }

    // === –ú–µ–Ω—é ===
    document.getElementById('menuToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.add('active');
      document.getElementById('overlay').classList.add('active');
    });

    document.getElementById('overlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    });

    document.querySelectorAll('.menu-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        this.style.transform = 'scale(0.97)';
        setTimeout(() => this.style.transform = '', 150);
      });
    });

    // === üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è ===
    document.getElementById('geolocate-btn').addEventListener('click', function() {
      if (!navigator.geolocation) {
        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        return;
      }

      const btn = this;
      btn.innerHTML = '‚è≥';
      btn.style.borderColor = '#ff9999';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          map.setCenter([position.coords.latitude, position.coords.longitude], 14);
          btn.innerHTML = 'üìç';
          btn.style.borderColor = '#ff3b30';
        },
        (error) => {
          alert(error.code === 1
            ? '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω'
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          btn.innerHTML = 'üìç';
          btn.style.borderColor = '#ff3b30';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    });
  </script>
</body>
</html>